<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de DARFs - Extração de Código de Barras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a3a8f;
            --primary-dark: #153072;
            --accent: #ffcc00;
            --success: #28a745;
            --bg: #f8f9fa;
        }
        
        body {
            background-color: var(--bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #2a5bd7 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-bottom: 5px solid var(--accent);
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .file-upload-area {
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background-color: #f0f5ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background-color: #e1ebff;
            border-color: var(--primary-dark);
        }
        
        .result-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left: 5px solid var(--success);
        }
        
        .barcode-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--primary);
            word-break: break-all;
            letter-spacing: 2px;
        }
        
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .field-highlight {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.1rem;
            border-radius: 4px;
        }
        
        .field-1 { background: #bbdefb; }
        .field-2 { background: #c8e6c9; }
        .field-3 { background: #fff9c4; }
        .field-4 { background: #ffccbc; }
        
        .status-valid { color: var(--success); }
        .status-invalid { color: #dc3545; }
        
        .table-results th {
            background-color: var(--primary);
            color: white;
        }
        
        .counter-badge {
            background-color: var(--accent);
            color: #333;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-file-invoice-dollar"></i> Leitor de DARFs</h1>
                    <p class="lead mb-0">Extração precisa de código de barras de documentos DARF</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="counter-badge badge p-3 fs-6">
                        <i class="fas fa-file-alt me-2"></i>
                        <span id="totalProcessed">0</span> processados
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Upload -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i> Upload de DARFs</h4>
            </div>
            <div class="card-body">
                <div class="file-upload-area" id="dropArea">
                    <i class="fas fa-file-pdf fa-4x mb-3 text-primary"></i>
                    <h4>Arraste PDFs aqui ou clique para selecionar</h4>
                    <p class="text-muted mb-3">Suporta múltiplos arquivos PDF</p>
                    <input type="file" id="fileInput" class="d-none" multiple accept=".pdf">
                    <button id="selectBtn" class="btn btn-primary btn-lg">
                        <i class="fas fa-folder-open me-2"></i> Selecionar Arquivos
                    </button>
                </div>
                
                <div id="fileListContainer" class="mt-4" style="display: none;">
                    <h5>Arquivos selecionados:</h5>
                    <div id="fileList"></div>
                    <div class="mt-3">
                        <button id="processBtn" class="btn btn-success btn-lg me-2">
                            <i class="fas fa-cogs me-2"></i> Processar DARFs
                        </button>
                        <button id="clearBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-trash me-2"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resultados -->
        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i> Resultados da Extração</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-results">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Arquivo</th>
                                <th>Código de Barras (44 dígitos)</th>
                                <th>Vencimento</th>
                                <th>CNPJ</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button id="exportBtn" class="btn btn-primary">
                        <i class="fas fa-file-excel me-2"></i> Exportar Excel
                    </button>
                    <button id="copyAllBtn" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-copy me-2"></i> Copiar Códigos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Debug -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bug me-2"></i> Log de Debug
                    <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearDebug()">Limpar</button>
                </h5>
            </div>
            <div class="card-body">
                <div class="debug-section" id="debugLog">
                    <p class="text-muted">Os logs de processamento aparecerão aqui...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Configuração do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Variáveis globais
        let selectedFiles = [];
        let results = [];
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const dropArea = document.getElementById('dropArea');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultsCard = document.getElementById('resultsCard');
        const resultsBody = document.getElementById('resultsBody');
        const debugLog = document.getElementById('debugLog');
        const totalProcessed = document.getElementById('totalProcessed');
        
        // Funções de debug
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: '#0d6efd',
                success: '#198754',
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: ${colors[type]}">[${time}] ${message}</span>`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearDebug() {
            debugLog.innerHTML = '<p class="text-muted">Log limpo.</p>';
        }
        
        // Event Listeners
        selectBtn.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('click', (e) => {
            if (e.target === dropArea || e.target.tagName === 'I' || e.target.tagName === 'H4' || e.target.tagName === 'P') {
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#153072';
            dropArea.style.backgroundColor = '#e1ebff';
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#1a3a8f';
            dropArea.style.backgroundColor = '#f0f5ff';
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#1a3a8f';
            dropArea.style.backgroundColor = '#f0f5ff';
            handleFiles(e.dataTransfer.files);
        });
        
        processBtn.addEventListener('click', processFiles);
        clearBtn.addEventListener('click', clearAll);
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        document.getElementById('copyAllBtn').addEventListener('click', copyAllBarcodes);
        
        function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    if (!selectedFiles.some(f => f.name === file.name)) {
                        selectedFiles.push(file);
                        log(`Arquivo adicionado: ${file.name}`, 'info');
                    }
                }
            }
            updateFileList();
        }
        
        function updateFileList() {
            if (selectedFiles.length === 0) {
                fileListContainer.style.display = 'none';
                return;
            }
            
            fileListContainer.style.display = 'block';
            fileList.innerHTML = selectedFiles.map((file, i) => `
                <div class="alert alert-secondary py-2 mb-2">
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    ${file.name}
                    <button class="btn btn-sm btn-outline-danger float-end py-0" onclick="removeFile(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }
        
        function clearAll() {
            selectedFiles = [];
            results = [];
            fileInput.value = '';
            updateFileList();
            resultsCard.style.display = 'none';
            resultsBody.innerHTML = '';
            clearDebug();
        }
        
        async function processFiles() {
            if (selectedFiles.length === 0) return;
            
            results = [];
            resultsBody.innerHTML = '';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processando...';
            
            log('=== INICIANDO PROCESSAMENTO ===', 'info');
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                log(`Processando: ${file.name}`, 'info');
                
                try {
                    const data = await extractDARFData(file);
                    data.fileName = file.name.replace(/\.pdf$/i, '');
                    results.push(data);
                    addResultRow(data, i + 1);
                    log(`✓ Sucesso: ${file.name} - Código: ${data.barcode}`, 'success');
                } catch (error) {
                    log(`✗ Erro em ${file.name}: ${error.message}`, 'error');
                    results.push({
                        fileName: file.name,
                        barcode: 'ERRO',
                        dueDate: '-',
                        cnpj: '-',
                        value: '-',
                        status: 'Erro'
                    });
                    addResultRow(results[results.length - 1], i + 1);
                }
            }
            
            resultsCard.style.display = 'block';
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-cogs me-2"></i> Processar DARFs';
            totalProcessed.textContent = parseInt(totalProcessed.textContent) + selectedFiles.length;
            
            log('=== PROCESSAMENTO CONCLUÍDO ===', 'success');
        }
        
        async function extractDARFData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const pdfData = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        
                        log(`PDF carregado: ${pdf.numPages} página(s)`, 'info');
                        
                        // Extrair texto de todas as páginas
                        let fullText = '';
                        let textItems = [];
                        
                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const textContent = await page.getTextContent();
                            
                            // Armazenar items com suas posições
                            textContent.items.forEach(item => {
                                textItems.push({
                                    text: item.str,
                                    x: item.transform[4],
                                    y: item.transform[5]
                                });
                            });
                            
                            // Texto separado por espaço
                            fullText += textContent.items.map(item => item.str).join(' ') + ' ';
                        }
                        
                        log(`Texto extraído (${fullText.length} caracteres)`, 'info');
                        log(`Primeiros 200 chars: ${fullText.substring(0, 200)}`, 'info');
                        
                        // Extrair dados
                        const barcode = extractBarcode(fullText, textItems);
                        const dueDate = extractDueDate(fullText);
                        const cnpj = extractCNPJ(fullText);
                        const value = extractValue(fullText);
                        
                        resolve({
                            barcode: barcode,
                            dueDate: dueDate,
                            cnpj: cnpj,
                            value: value,
                            status: barcode.length === 44 ? 'OK' : 'Verificar'
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        /**
         * VALIDAÇÃO MÓDULO 10 - Usado para dígitos verificadores de cada campo
         * @param {string} bloco - Bloco de 11 dígitos
         * @returns {number} - Dígito verificador calculado (0-9)
         */
        function calcularDVMod10(bloco) {
            let soma = 0;
            let peso = 2;
            
            for (let i = bloco.length - 1; i >= 0; i--) {
                let multiplicacao = parseInt(bloco.charAt(i)) * peso;
                if (multiplicacao >= 10) {
                    multiplicacao = Math.floor(multiplicacao / 10) + (multiplicacao % 10);
                }
                soma += multiplicacao;
                peso = peso === 2 ? 1 : 2;
            }
            
            const resto = soma % 10;
            return resto === 0 ? 0 : 10 - resto;
        }
        
        /**
         * VALIDAÇÃO MÓDULO 11 - Usado para dígito verificador geral
         * @param {string} codigo - Código de 43 dígitos (sem o DV geral)
         * @returns {number} - Dígito verificador calculado
         */
        function calcularDVMod11(codigo) {
            let soma = 0;
            let peso = 2;
            
            for (let i = codigo.length - 1; i >= 0; i--) {
                soma += parseInt(codigo.charAt(i)) * peso;
                peso++;
                if (peso > 9) peso = 2;
            }
            
            const resto = soma % 11;
            if (resto === 0 || resto === 1) return 0;
            if (resto === 10) return 1;
            return 11 - resto;
        }
        
        /**
         * Valida um campo de 12 dígitos (11 + DV) usando Módulo 10
         */
        function validarCampoMod10(campo12) {
            if (campo12.length !== 12) return false;
            const bloco = campo12.substring(0, 11);
            const dvInformado = parseInt(campo12.charAt(11));
            const dvCalculado = calcularDVMod10(bloco);
            return dvInformado === dvCalculado;
        }
        
        /**
         * Converte LINHA DIGITÁVEL (48 dígitos) para CÓDIGO DE BARRAS (44 dígitos)
         * 
         * Linha Digitável: CAMPO1(11)+DV1(1) + CAMPO2(11)+DV2(1) + CAMPO3(11)+DV3(1) + CAMPO4(11)+DV4(1) = 48
         * Código Barras:   CAMPO1(11) + CAMPO2(11) + CAMPO3(11) + CAMPO4(11) = 44
         */
        function linhaDigitavelParaCodigoBarras(linha48) {
            if (linha48.length !== 48) {
                log(`Linha digitável inválida: ${linha48.length} dígitos (esperado 48)`, 'warning');
                return null;
            }
            
            // Extrair os 4 campos de 12 dígitos
            const campo1 = linha48.substring(0, 12);  // 11 + DV
            const campo2 = linha48.substring(12, 24); // 11 + DV
            const campo3 = linha48.substring(24, 36); // 11 + DV
            const campo4 = linha48.substring(36, 48); // 11 + DV
            
            log(`Campo 1: ${campo1} (DV: ${campo1.charAt(11)})`, 'info');
            log(`Campo 2: ${campo2} (DV: ${campo2.charAt(11)})`, 'info');
            log(`Campo 3: ${campo3} (DV: ${campo3.charAt(11)})`, 'info');
            log(`Campo 4: ${campo4} (DV: ${campo4.charAt(11)})`, 'info');
            
            // Validar cada campo
            const valido1 = validarCampoMod10(campo1);
            const valido2 = validarCampoMod10(campo2);
            const valido3 = validarCampoMod10(campo3);
            const valido4 = validarCampoMod10(campo4);
            
            log(`Validação Mod10 - Campo1: ${valido1 ? '✓' : '✗'}, Campo2: ${valido2 ? '✓' : '✗'}, Campo3: ${valido3 ? '✓' : '✗'}, Campo4: ${valido4 ? '✓' : '✗'}`, 
                (valido1 && valido2 && valido3 && valido4) ? 'success' : 'warning');
            
            // Montar código de barras (remover DVs)
            const codigoBarras = campo1.substring(0, 11) + 
                                 campo2.substring(0, 11) + 
                                 campo3.substring(0, 11) + 
                                 campo4.substring(0, 11);
            
            log(`Código de barras montado: ${codigoBarras} (${codigoBarras.length} dígitos)`, 'success');
            
            return codigoBarras;
        }
        
        /**
         * EXTRAÇÃO DO CÓDIGO DE BARRAS - FUNÇÃO PRINCIPAL
         * 
         * O DARF tem LINHA DIGITÁVEL (48 dígitos visíveis) e CÓDIGO DE BARRAS (44 dígitos)
         * 
         * LINHA DIGITÁVEL (formato visual):
         * "85860000000 4 25970385260 7 13070126009 0 28520539909 8"
         * = Campo1(11) DV1(1) Campo2(11) DV2(1) Campo3(11) DV3(1) Campo4(11) DV4(1) = 48 dígitos
         * 
         * CÓDIGO DE BARRAS (44 dígitos - remove os DVs de cada campo):
         * "85860000000" + "25970385260" + "13070126009" + "28520539909" = 44 dígitos
         */
        function extractBarcode(text, textItems) {
            log('=== EXTRAINDO CÓDIGO DE BARRAS ===', 'info');
            
            // MÉTODO 1: Procurar padrão completo da linha digitável (48 dígitos)
            // Formato: 11 dígitos + espaço + 1 dígito + espaço (4 vezes)
            const pattern48 = /(\d{11})\s*(\d)\s+(\d{11})\s*(\d)\s+(\d{11})\s*(\d)\s+(\d{11})\s*(\d)/g;
            let match48 = pattern48.exec(text);
            
            if (match48) {
                // Montar linha digitável completa (48 dígitos)
                const linhaDigitavel = match48[1] + match48[2] + match48[3] + match48[4] + 
                                       match48[5] + match48[6] + match48[7] + match48[8];
                log(`MÉTODO 1 - Linha digitável encontrada: ${linhaDigitavel} (${linhaDigitavel.length} dígitos)`, 'info');
                
                if (linhaDigitavel.length === 48) {
                    // Converter para código de barras (44 dígitos)
                    const codigoBarras = linhaDigitavelParaCodigoBarras(linhaDigitavel);
                    if (codigoBarras && codigoBarras.length === 44) {
                        return codigoBarras;
                    }
                }
            }
            
            // MÉTODO 2: Procurar antes de "AUTENTICAÇÃO MECÂNICA"
            const authPattern = /([\d\s]+)\s*AUTENTICA/i;
            const authMatch = text.match(authPattern);
            
            if (authMatch) {
                log(`Encontrou antes de AUTENTICAÇÃO: "${authMatch[1].trim()}"`, 'info');
                
                // Extrair apenas dígitos
                const digits = authMatch[1].replace(/[^\d]/g, '');
                log(`Dígitos extraídos: ${digits} (${digits.length} dígitos)`, 'info');
                
                // Se tem 48 dígitos, converter para 44
                if (digits.length >= 48 && digits.startsWith('8')) {
                    const linha48 = digits.substring(0, 48);
                    const codigoBarras = linhaDigitavelParaCodigoBarras(linha48);
                    if (codigoBarras && codigoBarras.length === 44) {
                        log(`MÉTODO 2 - Código de barras: ${codigoBarras}`, 'success');
                        return codigoBarras;
                    }
                }
                
                // Se tem exatamente 44 dígitos, usar diretamente
                if (digits.length === 44 && digits.startsWith('8')) {
                    log(`MÉTODO 2 - Código direto (44): ${digits}`, 'success');
                    return digits;
                }
            }
            
            // MÉTODO 3: Procurar antes de "CNPJ:" na seção PIX
            const pixPattern = /([\d\s]+)\s*CNPJ\s*:/i;
            const pixMatch = text.match(pixPattern);
            
            if (pixMatch) {
                log(`Encontrou antes de CNPJ: "${pixMatch[1].trim()}"`, 'info');
                
                const digits = pixMatch[1].replace(/[^\d]/g, '');
                log(`Dígitos extraídos: ${digits} (${digits.length} dígitos)`, 'info');
                
                // Se tem 48 dígitos, converter para 44
                for (let i = 0; i <= digits.length - 48; i++) {
                    const candidate = digits.substring(i, i + 48);
                    if (candidate.startsWith('8')) {
                        const codigoBarras = linhaDigitavelParaCodigoBarras(candidate);
                        if (codigoBarras && codigoBarras.length === 44) {
                            log(`MÉTODO 3 - Código de barras: ${codigoBarras}`, 'success');
                            return codigoBarras;
                        }
                    }
                }
            }
            
            // MÉTODO 4: Extrair todos os dígitos e procurar linha digitável de 48
            const allDigits = text.replace(/[^\d]/g, '');
            log(`Total de dígitos no texto: ${allDigits.length}`, 'info');
            log(`Primeiros 100 dígitos: ${allDigits.substring(0, 100)}`, 'info');
            
            // Procurar linha digitável de 48 dígitos que começa com 858
            for (let i = 0; i <= allDigits.length - 48; i++) {
                const candidate = allDigits.substring(i, i + 48);
                
                if (candidate.startsWith('858')) {
                    log(`MÉTODO 4 - Candidato 48 dígitos: ${candidate}`, 'info');
                    const codigoBarras = linhaDigitavelParaCodigoBarras(candidate);
                    if (codigoBarras && codigoBarras.length === 44) {
                        log(`MÉTODO 4 - Código de barras: ${codigoBarras}`, 'success');
                        return codigoBarras;
                    }
                }
            }
            
            // MÉTODO 5: Se não encontrou 48, procurar diretamente 44 dígitos
            for (let i = 0; i <= allDigits.length - 44; i++) {
                const candidate = allDigits.substring(i, i + 44);
                
                if (candidate.startsWith('858')) {
                    log(`MÉTODO 5 - Código direto 44: ${candidate}`, 'success');
                    return candidate;
                }
            }
            
            // MÉTODO 6: Último recurso - qualquer sequência de 44 começando com 8
            for (let i = 0; i <= allDigits.length - 44; i++) {
                const candidate = allDigits.substring(i, i + 44);
                
                if (candidate.startsWith('8')) {
                    log(`MÉTODO 6 - Qualquer 44 com 8: ${candidate}`, 'warning');
                    return candidate;
                }
            }
            
            log('Código de barras não encontrado!', 'error');
            return 'NÃO ENCONTRADO';
        }
        
        function extractDueDate(text) {
            // Padrão: DD/MM/AAAA
            const patterns = [
                /Vencimento[:\s]*(\d{2}\/\d{2}\/\d{4})/i,
                /Pagar\s+(?:este\s+documento\s+)?at[ée][:\s]*(\d{2}\/\d{2}\/\d{4})/i,
                /Data\s+(?:de\s+)?Vencimento[:\s]*(\d{2}\/\d{2}\/\d{4})/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            
            // Procurar qualquer data no formato DD/MM/AAAA
            const dateMatch = text.match(/(\d{2}\/\d{2}\/\d{4})/);
            return dateMatch ? dateMatch[1] : '-';
        }
        
        function extractCNPJ(text) {
            const match = text.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
            return match ? match[1] : '-';
        }
        
        function extractValue(text) {
            // Procurar valor após "Valor:" ou "Total"
            const patterns = [
                /Valor[:\s]*R?\$?\s*([\d.,]+)/i,
                /Total[:\s]*R?\$?\s*([\d.,]+)/i,
                /Valor\s+Total[:\s]*R?\$?\s*([\d.,]+)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    return 'R$ ' + match[1];
                }
            }
            
            return '-';
        }
        
        function addResultRow(data, index) {
            const statusClass = data.barcode.length === 44 ? 'text-success' : 'text-danger';
            const statusIcon = data.barcode.length === 44 ? 'check-circle' : 'exclamation-circle';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index}</td>
                <td>${data.fileName}</td>
                <td>
                    <code class="barcode-display" style="font-size: 0.75rem; padding: 0.5rem;">
                        ${data.barcode}
                    </code>
                    <br>
                    <small class="text-muted">${data.barcode.length} dígitos</small>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyBarcode('${data.barcode}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </td>
                <td>${data.dueDate}</td>
                <td>${data.cnpj}</td>
                <td>${data.value}</td>
                <td class="${statusClass}">
                    <i class="fas fa-${statusIcon} me-1"></i>
                    ${data.status}
                </td>
            `;
            resultsBody.appendChild(row);
        }
        
        function copyBarcode(barcode) {
            navigator.clipboard.writeText(barcode).then(() => {
                alert('Código copiado!');
            });
        }
        
        function copyAllBarcodes() {
            const barcodes = results.map(r => r.barcode).join('\n');
            navigator.clipboard.writeText(barcodes).then(() => {
                alert('Todos os códigos copiados!');
            });
        }
        
        function exportToExcel() {
            const data = results.map((r, i) => ({
                '#': i + 1,
                'Arquivo': r.fileName,
                'Código de Barras': r.barcode,
                'Tamanho': r.barcode.length,
                'Vencimento': r.dueDate,
                'CNPJ': r.cnpj,
                'Valor': r.value,
                'Status': r.status
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'DARFs');
            XLSX.writeFile(wb, `darfs_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            log('Arquivo Excel exportado!', 'success');
        }
    </script>
</body>
</html>
